# 复制

复制的数据是单向的，从主节点（master）到从节点（slave）。

## 配置

### 建立复制

- 配置文件加入`slaveof {masterhost} {masterport}`
- `redis-server`启动命令后加入`slaveof {masterhost} {masterport}`
- 直接命令：`slaveof {masterhost} {masterport}`

使用`info replication`查看复制状态信息。

### 断开复制

从节点上面执行`slaveof no one`来断开，保留以前的数据。

切换到另一个主节点`slaveof {newasterhost} {newmasterport}`，清空之前的数据

### 安全性

可以设置密码验证。

#### 只读

从节点只读模式`slave-read-only=yes`。

#### 传输延迟

`repl-disable-tcp-nodelay`控制是否关闭 tcp-nodelay，默认关闭。

- 关闭时，主从节点数据实时更新，延迟小，网络带宽大，适用于网络较好的情况，比如同机房。
- 开启时，主节点会合并较小的 TCP 数据包从而节省带宽。默认发送时间间隔取决于 linux 内核，一般为 40 毫秒，增大延迟，适用于网络条件不好，如跨机房布置。

## 拓扑

### 一主一从

### 一主多从

读写分离，读命令在从节点执行，同时可以执行一些耗时较长的命令。不适用于写并发量较高的场景。

### 树状主从结构

当主节点需要挂载多个从节点时，可以采用树状主从结构降低主节点的压力。

## 原理

如果 master 同时收到多个 slave 发来的同步连接命令，master 只会启动一个进程来写数据库镜像，然后发送给所有的 slave。master 同步数据时是非阻塞式的，可以接收用户的读写请求。然而在 slave 端是阻塞模式的，slave 在同步 master 数据时，并不能够响应客户端的查询。

### 复制过程

1. 保存主节点信息
2. 主从建立 socket 连接
3. 发送 ping 命令
4. 权限验证
5. 同步数据集
6. 命令持续复制

### 数据同步

全量复制：早期版本只支持该功能，一般用于初次复制场景。

部分复制：用于处理主从复制中因网络等原因造成的数据丢失场景。

1. 复制偏移量
2. 复制积压缓冲区
3. 主节点运行 ID
4. psync 命令

## 应用场景

### 读写分离（不推荐）

对于读占比较高的场景，可以将一部分读数据分摊到 slave 从节点，但只能对 master 主节点进行写操作。

可能遇到的问题：

1. 数据延迟：由于异步复制的特性无法避免，如果无法容忍大量延迟，可使用外部程序监听只从节点的复制偏移量。
2. 读到过期数据：因为从节点自身不会主动删除过期数据（保证复制的一致性），所以需要等待主节点的异步删除命令，可以升级到 Redis 3.2 规避这个问题，从节点读取数据之前会检查键的过期时间决定是否返回结果。
3. 从节点故障

读写分离有一定的成本，所以尽量在主节点上优化，可以用 Redis Cluster 分布式方案代替。

### 主从配置不一致

内存相关的配置必须要一致。

### 规避全量复制

- 第一次建立复制：无法避免，在低峰时操作。
- 节点运行 ID 不匹配：主节点发生故障，手动升级从节点为主节点，或者支持自动故障转移的哨兵，或者集群方案。
