# 复制

复制的数据是单向的，从主节点（master）到从节点（slave）。

## 配置

### 建立复制

- 配置文件加入`slaveof {masterhost} {masterport}`
- `redis-server`启动命令后加入`slaveof {masterhost} {masterport}`
- 直接命令：`slaveof {masterhost} {masterport}`

使用`info replication`查看复制状态信息。

### 断开复制

从节点上面执行`slaveof no one`来断开，保留以前的数据。

切换到另一个主节点`slaveof {newasterhost} {newmasterport}`，清空之前的数据

### 安全性

可以设置密码验证。

#### 只读

从节点只读模式`slave-read-only=yes`。

#### 传输延迟

`repl-disable-tcp-nodelay`控制是否关闭 tcp-nodelay，默认关闭。

- 关闭时，主从节点数据实时更新，延迟小，网络带宽大，适用于网络较好的情况，比如同机房。
- 开启时，主节点会合并较小的TCP数据包从而节省带宽。默认发送时间间隔取决于linux内核，一般为40毫秒，增大延迟，适用于网络条件不好，如跨机房布置。

## 拓扑

### 一主一从

### 一主多从

读写分离，读命令在从节点执行，同时可以执行一些耗时较长的命令。不适用于写并发量较高的场景。

### 树状主从结构

当主节点需要挂载多个从节点时，可以采用树状主从结构降低主节点的压力。

## 原理

### 复制过程

1. 保存主节点信息
2. 主从建立 socket 连接
3. 发送 ping 命令
4. 权限验证
5. 同步数据集
6. 命令持续复制

### 数据同步

全量复制：早期版本只支持该功能，一般用于初次复制场景。

部分复制：用于处理主从复制中因网络等原因造成的数据丢失场景。

1. 复制偏移量
2. 复制积压缓冲区
3. 主节点运行ID
4. psync 命令
5. 

