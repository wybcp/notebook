# 集群

Redis 分布式解决方案 Redis Cluster。

## 数据分布

分布式数据库首先解决整个数据集按照分区规则映射到多个节点，重点在于数据分区规则。

Redis Cluster 采用虚拟槽分区，所有的键根据哈希函数映射到 0~16383 整数槽（slot），计算公式：`slot=CRC16(key)&16383`，每个节点负责维护一部分槽以及槽所映射的键值数据。

客户端在对 key 进行读写操作时，可以连接 Cluster 中的任意一个分片，如果操作的 key 不在此分片负责的 Slot 范围内，Redis Cluster 会自动将请求重定向到正确的分片上。

## 集群功能限制

很多情况下只支持具有相同 slot 值的 key 的操作。

- key 事务支持有限。
- key 批量操作支持有限。
- hash、list 只能保存到同意节点。
- 只能使用一个数据库空间 db 0。
- 复制结构只支持一层。

## 集群节点

实例的集群模式需要通过配置来开启， 开启集群模式的实例将可以使用集群特有的功能和命令。

集群配置文件示例：

```conf
port 7000
cluster-enabled yes
cluster-config-file nodes.conf
cluster-node-timeout 5000
appendonly yes
```

文件中的 `cluster-enabled` 选项用于开实例的集群模式， 而 `cluster-conf-file` 选项则设定了保存节点配置文件的路径， 默认值为 `nodes.conf` 。

节点配置文件无须人为修改， 它由 Redis 集群在启动时创建， 并在有需要时自动进行更新。

集群正常运作强烈建议使用六个节点： 其中三个为主节点， 而其余三个则是各个主节点的从节点。

首先， 让我们进入一个新目录， 并创建六个以端口号为名字的子目录， 稍后我们在将每个目录中运行一个 Redis 实例：

```shell
mkdir cluster-test
cd cluster-test
mkdir 7000 7001 7002 7003 7004 7005
```

## 主从复制 vs 集群分片

在设计软件架构时，要如何在主从复制和集群分片两种部署方案中取舍呢？

从各个方面看，Redis Cluster 都是优于主从复制的方案

- Redis Cluster 能够解决单节点上数据量过大的问题
- Redis Cluster 能够解决单节点访问压力过大的问题
- Redis Cluster 包含了主从复制的能力

### 采用 Redis Cluster 的弊端

- 维护难度增加。在使用 Redis Cluster 时，需要维护的 Redis 实例数倍增，需要监控的主机数量也相应增加，数据备份/持久化的复杂度也会增加。同时在进行分片的增减操作时，还需要进行 reshard 操作，远比主从模式下增加一个 Slave 的复杂度要高。
- 客户端资源消耗增加。当客户端使用连接池时，需要为每一个数据分片维护一个连接池，客户端同时需要保持的连接数成倍增多，加大了客户端本身和操作系统资源的消耗。
- 性能优化难度增加。你可能需要在多个分片上查看 Slow Log 和 Swap 日志才能定位性能问题。
- 事务和 LUA Script 的使用成本增加。在 Redis Cluster 中使用事务和 LUA Script 特性有严格的限制条件，事务和 Script 中操作的 key 必须位于同一个分片上，这就使得在开发时必须对相应场景下涉及的 key 进行额外的规划和规范要求。如果应用的场景中大量涉及事务和 Script 的使用，如何在保证这两个功能的正常运作前提下把数据平均分到多个数据分片中就会成为难点。

所以说，在主从复制和集群分片两个方案中做出选择时，应该从应用软件的功能特性、数据和访问量级、未来发展规划等方面综合考虑，只在确实有必要引入数据分片时再使用 Redis Cluster。

综合上面几点考虑，如果单台主机的可用物理内存完全足以支撑对 Redis 的容量需求，且 Redis 面临的并发写压力距离 Benchmark 值还尚有距离，建议采用主从复制的架构，可以省去很多不必要的麻烦。同时，如果应用中大量使用 pipelining 和事务，也建议尽可能选择主从复制架构，可以减少设计和开发时的复杂度。
