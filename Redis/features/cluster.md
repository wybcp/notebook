# 集群

Redis 分布式解决方案 Redis Cluster。

## 数据分布

分布式数据库首先解决整个数据集按照分区规则映射到多个节点，重点在于数据分区规则。

Redis Cluster 采用虚拟槽分区，所有的键根据哈希函数映射到 0~16383 整数槽（slot），计算公式：`slot=CRC16(key)&16383`，每个节点负责维护一部分槽以及槽所映射的键值数据。

## 集群功能限制

很多情况下只支持具有相同slot 值的key的操作。

- key 事务支持有限。
- key 批量操作支持有限。
- hash、list只能保存到同意节点。
- 只能使用一个数据库空间 db 0。
- 复制结构只支持一层。

## 集群节点

Redis 集群由多个运行在集群模式（cluster mode）下的 Redis 实例组成， 实例的集群模式需要通过配置来开启， 开启集群模式的实例将可以使用集群特有的功能和命令。

以下是一个包含了最少选项的集群配置文件示例：

```
port 7000
cluster-enabled yes
cluster-config-file nodes.conf
cluster-node-timeout 5000
appendonly yes
```

文件中的 `cluster-enabled` 选项用于开实例的集群模式， 而 `cluster-conf-file` 选项则设定了保存节点配置文件的路径， 默认值为 `nodes.conf` 。

节点配置文件无须人为修改， 它由 Redis 集群在启动时创建， 并在有需要时自动进行更新。

**要让集群正常运作至少需要三个主节点**， 不过在刚开始试用集群功能时， 强烈建议使用六个节点： 其中三个为主节点， 而其余三个则是各个主节点的从节点。

首先， 让我们进入一个新目录， 并创建六个以端口号为名字的子目录， 稍后我们在将每个目录中运行一个 Redis 实例：

```
mkdir cluster-test
cd cluster-test
mkdir 7000 7001 7002 7003 7004 7005
```

在文件夹 `7000` 至 `7005` 中， 各创建一个 `redis.conf` 文件， 文件的内容可以使用上面的示例配置文件， 但记得将配置中的端口号从 `7000` 改为与文件夹名字相同的号码。