# 优化

调优分为三个部分：硬件、软件、网络。
记录慢查询日志，分析查询日志，不要直接打开慢查询日志进行分析，这样比较浪费时间和精力，可以使用 pt-query-digest 工具进行分析

## 使用 show profile

```config
set profiling=1;#开启，服务器上所有执行语句会记录执行时间，存到临时表中show profilesshow profile for query 临时表ID
```

## 尽快关闭连接

一条sql请求处理完之后，需要释放连接，调整`wait_timeout`（默认值为 28800s）调整为 100s，尽快释放连接，可以减小内存消耗，也避免出现连接过多的报错。

## 使用 show status

show status 会返回一些计数器，show global status 会查看所有服务器级别的所有计数有时根据这些计数，可以推测出哪些操作代价较高或者消耗时间多

## show processlist

观察是否有大量线程处于不正常的状态或特征

最常问的 MySQL 面试题五——每个开发人员都应该知道

###### 使用 explain

分析单条 SQL 语句

**优化查询过程中的数据访问**

- 访问数据太多导致查询性能下降
- 确定应用程序是否在检索大量超过需要的数据，可能是太多行或列
- 确认 MySQL 服务器是否在分析大量不必要的数据行
- 避免犯如下 SQL 语句错误
- 查询不需要的数据。解决办法：使用 limit 解决
- 多表关联返回全部列。解决办法：指定列名
- 总是返回全部列。解决办法：避免使用 SELECT \*
- 重复查询相同的数据。解决办法：可以缓存数据，下次直接读取缓存
- 是否在扫描额外的记录。解决办法：
- 使用 explain 进行分析，如果发现查询需要扫描大量的数据，但只返回少数的行，可以通过如下技巧去优化：
- 使用索引覆盖扫描，把所有的列都放到索引中，这样存储引擎不需要回表获取对应行就可以返回结果。
- 改变数据库和表的结构，修改数据表范式
- 重写 SQL 语句，让优化器可以以更优的方式执行查询。

**优化长难的查询语句**

- 一个复杂查询还是多个简单查询
- MySQL 内部每秒能扫描内存中上百万行数据，相比之下，响应数据给客户端就要慢得多
- 使用尽可能小的查询是好的，但是有时将一个大的查询分解为多个小的查询是很有必要的。
- 切分查询
- 将一个大的查询分为多个小的相同的查询
- 一次性删除 1000 万的数据要比一次删除 1 万，暂停一会的方案更加损耗服务器开销。
- 分解关联查询，让缓存的效率更高。
- 执行单个查询可以减少锁的竞争。
- 在应用层做关联更容易对数据库进行拆分。
- 查询效率会有大幅提升。
- 较少冗余记录的查询。

**优化特定类型的查询语句**

- count(\*)会忽略所有的列，直接统计所有列数，不要使用 count(列名)
- MyISAM 中，没有任何 where 条件的 count(\*)非常快。
- 当有 where 条件时，MyISAM 的 count 统计不一定比其它引擎快。
- 可以使用 explain 查询近似值，用近似值替代 count(\*)
- 增加汇总表
- 使用缓存

**优化关联查询**

- 确定 ON 或者 USING 子句中是否有索引。
- 确保 GROUP BY 和 ORDER BY 只有一个表中的列，这样 MySQL 才有可能使用索引。

**优化子查询**

- 用关联查询替代
- 优化 GROUP BY 和 DISTINCT
- 这两种查询据可以使用索引来优化，是最有效的优化方法
- 关联查询中，使用标识列分组的效率更高
- 如果不需要 ORDER BY，进行 GROUP BY 时加 ORDER BY NULL，MySQL 不会再进行文件排序。
- WITH ROLLUP 超级聚合，可以挪到应用程序处理

**优化 LIMIT 分页**

- LIMIT 偏移量大的时候，查询效率较低
- 可以记录上次查询的最大 ID，下次查询时直接根据该 ID 来查询

**优化 UNION 查询**

- UNION ALL 的效率高于 UNION

**优化 WHERE 子句**

## 半同步复制

半同步复制模式必须在主服务器和从服务器同时启用，不然主服务器默认使用异步复制模式。

保证主从数据一致性，等待返回的时间长短决定数据的更新速度。

## 目录

- [表设计](table.md)
- [字段设计](table.md)

