# 优化

调优分为三个部分：硬件、软件、网络。

优化原则是减小系统瓶颈，减少资源的占用，增加系统反应速度。

记录慢查询日志，分析查询日志，不要直接打开慢查询日志进行分析，这样比较浪费时间和精力，可以使用 pt-query-digest 工具进行分析

## 使用 show profile

```conf
set profiling=1;#开启，服务器上所有执行语句会记录执行时间，存到临时表中show profilesshow profile for query 临时表ID
```

## 连接处理

一条 sql 请求处理完之后，需要释放连接，调整`wait_timeout`（默认值为 28800s）调整为 100s，尽快释放连接，可以减小内存消耗，也避免出现连接过多的报错。

但是建立连接的过程通常是比较复杂的，建议你在使用中要尽量减少建立连接的动作，也就是尽量使用长连接。

但是全部使用长连接后，有些时候 MySQL 占用内存涨得特别快，这是因为 MySQL 在执行过程中临时使用的内存是管理在连接对象里面的。这些资源会在连接断开的时候才释放。所以如果长连接累积下来，可能导致内存占用太大，被系统强行杀掉（OOM），从现象看就是 MySQL 异常重启了。

怎么解决这个问题呢？两种方案。

- 定期断开长连接。使用一段时间，或者程序里面判断执行过一个占用内存的大查询后，断开连接，之后要查询再重连。
- 如果你用的是 MySQL 5.7 或更新版本，可以在每次执行一个比较大的操作后，通过执行 `mysql_reset_connection` 来重新初始化连接资源。这个过程不需要重连和重新做权限验证，但是会将连接恢复到刚刚创建完时的状态。

## 使用 show status

show status 会返回一些计数器，show global status 会查看所有服务器级别的所有计数有时根据这些计数，可以推测出哪些操作代价较高或者消耗时间多

## show processlist

观察是否有大量线程处于不正常的状态或特征

最常问的 MySQL 面试题五——每个开发人员都应该知道

## 使用 explain

分析单条 SQL 语句

## 优化 LIMIT 分页

- LIMIT 偏移量大的时候，查询效率较低
- 可以记录上次查询的最大 ID，下次查询时直接根据该 ID 来查询

## 优化 UNION 查询

- UNION ALL 的效率高于 UNION

## 优化 WHERE 子句

## 半同步复制

半同步复制模式必须在主服务器和从服务器同时启用，不然主服务器默认使用异步复制模式。

保证主从数据一致性，等待返回的时间长短决定数据的更新速度。

## 目录

- [表设计](table.md)
- [字段设计](table.md)
